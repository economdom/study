# Бранчинг

У вас есть основной бранч (ветка), с которым вы работаете и вдруг у вас появляется идея, но вы не уверенны сработает она или нет и вместо того чтобы делать много коммитов в основной бранч, а затем их отменять, если что-то не сработает, вы просто создаёте новый бранч чтобы реализовать здесь все свои новые идеи. Если идея не сработала, вы просто удаляете бранч и ваш основной бранч не будет содержать лишнего кода. Но если идеи хорошо реализуются, то вы можете перенести эти идеи в основной бранч и этот процесс мы называем слиянием. 

Это может пригодится, например в таких случаях:

* Вы работаете в команде и при это создаёте две отдельных ветки одного проекта для фронт-энд и бэк-энд разработчиков. После этого вы делаете слияние проекта.
* Разработывая основной проект, вы решили что было бы не плохо добавить какой-то модуль, но конца вы не уверенны что он вам приходится и не знаете в какой именно момент вы хотели бы его подключить к основному проекту. Это постепенно можно выполнять в отдельной ветке, а когда реализуете и будете уверен в том что можно включить этот модуль в основной проект, тогда делаете слияние с основным бранчем.

Бранчи также позволяют изолировать определённые особенности и разделы работы - это особенно полезно, если вы сотрудничаете с другими людьми. К примеру, у вас есть веб-сайт и вы хотите изменить раздел пользовальской регистрации, для этого мы можем создать бранч, отдельно от основного и поработать над ним, привлечь других разработчиков к этой работе, тогда как другие могут работать с основным бранчем. Когда работа закоченаё и она всем нравится - мы можем сделать слияние с основным бранчем.

Когда мы создаём бранч, у нас всё ещё остаётся одна рабочая директория и все файлы, с которыми мы работаем остаются в той же папке проекта, что и до этого. Но когда мы делаем изменение бранча, то Git делает быстрое переключение контента.

У вас может быть много бранчей и не всегда нужно делать слияние с основным бранчем и мы можем обмениватся изменениями между ними.

По умолчанию, `HEAD` всегда указывает на последний коммит в основном бранче, но как только мы создаём новый бранч, то всё меняется. Когда мы создаём новый бранч, то `HEAD` до сих пор указывает на последний коммит основного бранча, до тех пор, пока не будет сделан первый коммит в новом бранче, тогда `HEAD` будет указывать на последний коммит нового бранча. После переключения обратно на основной бранч, тогда `HEAD` будет указывать на верхушку текущего (основного) бранча, а при переключении снова на новый бранч - `HEAD` снова переключается на послений коммит нового бранча.

## Просмотр и создание бранчей

Все бранчи в локальном репозитории можно просмотреть при помощи команды `git branch` - сама по себе эта команда покажет список бранчей, хранящихся на локальном компьютере. Звездочка напротив имени бранча, говорит о том что сейчас мы находимся в данном бранче. Мы относимся к нему как к текущему бранчу или бранчу, где был сделан чекаут.

Как уже говорилось ранее, ссылка на указатель `HEAD` хранится в папке *.git*. 

* В файле HEAD мы видим ссылку на текущий бранч - `ref: refs/heads/master`.
* Отобразим список файлов по данному пути, но не будем прописывать `master` чтобы увидеть список всех бранчей, перечисленных тут.

```bash
cat .git/HEAD
ls -al .git/refs/heads/
```

Когда мы создаём новые бранчи они будут показаны здесь и мы видим что добавленна новая ссылка в папке *.git/refs/heads/*. В файле бранча содержится SHA текущего бранча.

Для создания нового бранча нужно после вызова `git branch` указать имя нового бранча, в котором не должно быть пробелов и не должно быть пунктуации, тоесть вы можете использовать буквы, цифры и подчёркивания.

```bash
git branch new_features
git branch
```

Можно также создать ветку на определенном коммите

```bash
git branch new_branch 5a0eb04
```

## Переключение бранчей

Мы создали новый бранч, но пока ещё на него не переключились. Можем это проверить.

```bash
git branch
cat .git/HEAD
```

Для переключения бранчей используется команда `git checkout`. Переключимся в новый бранч и проверим это.

```bash
git checkout new_features
git branch
```

На данный момент `HEAD` указывает на один и тот же коммит. Мы не сделали пока что никаких изменений ни в одном бранче, ни в другом, поэтому их верхушки абсолютно идентичны.

* Сделаем изменения в новом бранче и закоммитим их
* Смотрим историю коммитов в бранче `new_features`
* Переключаемся в бранч `master`
* Проверяем историю коммитов в бранче `master` и убеждаемся что нового/последнего коммита в нём нет

```bash
git status
git commit -am "Change title index.html"
git status
git log --oneline
git checkout master
git branch
```

Если мы откроем файл, который редактировали ранее, то мы там не увидим никаких изменений, потому что они были сделанны и закоммиченны в другом бранче. Но если мы снова переключимся в другой бранч (`new_features`), где мы делали коммит, то мы снова увидим эти изменений.

```bash
vim index.html
git checkout new_features
vim index.html
```

Посмотреть последний коммит на каждой из локальных веток

```bash
git branch –v
```

Посмотреть последние коммиты на всех ветках (локальных и удаленных)

```bash
git branch –a -v
git branch -av
```

Посмотреть отслеживаемые ветки

```bash
git branch –vv
```

Как мы видим что очень удобно работать с разными вариантами вашего проекта простым переключением бранчей.

## Создание и переключение бранчей

В этом уроке мы разберём как нам создавать и переключатся между бранчами одновременно, чтобы нам не приходилось набирать обе команды.

В прошлом уроке мы изменили название в `index.html` и сейчас мы можем посмотреть на данный коммит при помощи `git show`. Для этого мы можем скопировать и вставить SHA, который на него ссылается или же просто указать `HEAD`, потому как он как раз и ссылается на этот коммит в данный момент времени.

```bash
git show HEAD
```

Данная строка покажет нам этот коммит, а также то что было измененно.

Допустим изменения, которые мы сейчас хотим сделать заключается в создании нового бранча, где мы будем сокращать название, тоесть мы создадим новый бранч и сделаем его чекаут одновременно

* Мы используем команду `git checkout` с опцией `-b`, которая означает создание и переключение бранча в одно и тоже время. Ранее мы указали не совсем корректное название для бранча - нужно давать более осмысленное и понятное имя, чтобы когда мы смотрели на его название и понимали к каким изменнениям он будет относится.
* Для того чтобы убедится в том что мы создали новый бранч и переключились в него мы можем убедится при помощи `git branch`.
* Теперь мы находимся в бранче `shorten_title` и теперь он влючает в себя коммит, который мы сделали в бранче `new_features`. Для того чтобы в этом убедится мы используем команду `git log --oneline`, тоесть мы сделали новый бранч не из `master`, а из `new_features`. Тоесть новый бранч создаётся на основе того в которым мы находились на момент создания нового бранча, тоесть то место где находился указатель `HEAD`
* Теперь мы можем сократить название в файле *index.html* в рабочей директории и закоммитить изменения.
* Когда мы проверим статус то мы увидим изменённый файл в рабочей директории. Перед тем как мы добавим изменения и сделаем коммит, я хочу вы ещё раз обратили ваше внимание на подсказку, которая появляется в момент проверки статуса - `git checkout -- <file>...`. Это команда, которую мы использовали ранее, когда хотели сбросить изменения в рабочей директории и тогда мы говорили о том что нужно использовать два дефиса, чтобы это было более очевидно - что мы не пытаемся сделать чекаут бранча, а пытаемся сделать чекаут файла. Тоесть команда `checkout` выполняет две функции - делает чекаут бранча и чекаут файла.
* Добавим изменения и закоммитим их
* Теперь если мы будем переключатся между бранчами, то мы можем видеть как меняется состояние проекта

```bash
git checkout -b shorten_title
git branch
git log --oneline
git commit -am "Shorten the title of index.html"
```

Можно использовать команду

```bash
git log --graph --oneline --decorate --all
```

Теперь можно увидить разные коммиты и показана верхушка в каждому из наших бранчей, а также текущее положение указателя `HEAD`, тоесть в каком бранче мы находимся на данный момент.

## Переключение бранчей с несохранёнными изменениями

Ваша рабочая директори должна быть чистой при переключении бранчей, на самом деле фактически чистой(поговорим об этом позже), то если она не чистая, тогда Git не позволит вам сделать переключение.

Если мы просто сделаем изменения в рабочей директории текущего бранча и затем заходим перейти в другой бранч, то мы увидим примерно следующее сообщение.

```bash
error: Your local changes to the following files would be overwritten by checkout:
        index.html
Please, commit your changes or stash them before you can switch branches.
Aborting
```

Для решения этой проблемы можно:

* Избавится от изменений сделав чекаут файла
* Закоммитить изменения
* Спрятать изменения (об этом позже). Мы можем спрятать эти изменения в небольшой области памяти, а затем вернёмся к ним, когда будем готовы

Рабочая директория должна быть практически чиста, потому что она не должна быть абсолютно чиста - она должна быть достаточно чиста чтобы не возникало конфликтов.

Мы можем добавить один не отслеживаемый файл в рабочую директорию и затем переключится в другой бранч, вот что имелось в виду, когда говорилось что рабочая директория должна быть практически чиста и у нас не должно быть ничего что приведёт к потере данных при переключении.

## Переименование бранча

Если вы вдруг обнаружили, что тот бранч, который вы ранее назвали не совсем подходит для того что именно происходит внутри данного бранча. Для этих целей используется флаг `-m` (*сокр.* move) или полное имя `--move`. На самом деле у нас происходит не перемещение, а переименование - точно также как мы ранее работали с файлами Git, а Git считает команды перемещение/переименование также как это делает Unix.

Переименование можно делать из любого бранча, главное что вы правильно указали название старого брача.

```bash
git branch -m new_features seo_title
git branch
```

Переименовать текущую ветку

```bash
git branch -m <newname>
```

Убедитесь что вы даёте брачам хорошие имена - имена, которые помогают понять что находится в этих брачах.

## Сравнение бранчей

Для сравнения двух коммитов мы использовали `git diff` чтобы сравнить два разных `tree-ish` объекта и тогда мы говорили о том что бранч это один из `tree-ish` объектов, которые мы можем передать, но тогда мы ещё не умели работать с брачами.

```bash
git diff master..seo_title
```

Одним цветом будут обозначатся изменения сделанные в одном бранче, другим цветом - в другом. Если изменить названия при вызове `git diff` то всё также будет работать, но изменится цвет изменений в файлах на протиположный, так как мы изменили порядок сравнения брачей.

Могут возникнуть трудности, когда разные коммиты будут сделанны в разных местах. Дело в том какой цвет вы хотите видеть для разных бранчей.

Можно отобразить изменения на одной строке и возможно для вас так будет понятней.

```bash
git diff --color-words master..seo_title
```

Как уже и говорилось, что в `diff` мы передаём не просто название бранча - мы передаём `tree-ish`. Объектом `tree-is` могут быть самые разные вещи. Он может включать в себя предка. Например мы можем сравнить последний коммит `master` и предыдущий коммит `new_features`.

```bash
git diff --color-words master..seo_title^
```

И ещё есть один важный способ с помощью которого можно сравнить брачи - он заключается в том чтобы выяснить полностью ли один бранч включает в себя другой, тоесть произошло не полное слияние с текущим брачем или нет. Для этих целей нужно вызвать следующую команду.

```bash
git branch --merged
```
Если отображаются все бранчи, значит в текущем бранче присутствуют изменения со всех бранчей, а если какие-то отсутствуют в списке, значит присутствуют не все, а только те изменения, бранчи которых есть в списке.

Можно изменить бранч на `master` и попробуйте снова вызвать эту команду, чтобы увидеть разницу.

Если всех коммитов нет в каком-то бранче, тогда нужно сделать слияние, чтобы эти изменения попали в основной бранч. На самом деле Git возвращается по цепочке предков в текущем бранче, чтобы увидеть содержится в ней верхушка бранча, а если в ней присутствует последние коммиты из `master` бранча тогда в нём есть и все предки.

## Удаление бранчей

В начале нужно создать тестовый бранч для того чтобы мы тогда могли удалить.

Удалить существующий бранч очень просто нужно лишь добавить опцию `-d` или аналог `--delete`.

```bash
git branch to_delete
git branch -d to_delete
```

Чтобы вы случайно не удалили что-то важное - у Git есть несколько проверок.

* Мы не можем удалить бранч, если на момент удаления мы находимся в нём. Вы бы не хотели спилить ветку на которой сидите - вы хотели б пересесть на другую прежде чем спилить старую

```bash
git branch to_delete
git checkout to_delete
git branch -d to_delete
```

* После создания нового бранча мы можем сделать в нём один или несколько коммитов и если захотим его удалить, то у нас ничего не получится. В Git  говорит нам что в данном бранче присутствуют изменения, которых нет в текущем бранче. Если вы точно хотите его удалить, тогда нужно использовать опцию `-D`.

```bash
vim index.html
git commit -am "Change title"
git checkout master
git branch -d to_delete
git branch -D to_delete
```