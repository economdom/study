# Цикл WordPress

Важно понять что цикл WordPress используется в каждом шаблоне и соответственно на каждой странице сайта - будь-то шаблон отдельной статьи (данные одной записи из БД) или шаблон со списком статей (несколько записей из БД). Также он может использоваться как внутри контента страницы, так и за её пределами (например в виджетах). Цикл в шаблоне можно использовать многократно (нет никаких ограничений по количеству используемых циклов), но каждый отдельный цикл формирует один или несколько SQL запросов к БД. Хоть цикл можно использовать где угодно внутри WordPress (шаблоны, виджеты, плагины и т. д.), но в зависимости от конкретного места существуют разные методы создания цикла.

Цикл выбирает записи из базы данных MySQL на основе набора параметров, которые по умолчанию опре­деляются через URL. Например:

* Домашняя страница по умолчанию должна отображать все записи блога в обрат­ном хронологическом порядке
* Страница категории, показывает только записи блога, относящиеся к этой категории
* Страница архива показывает только записи блога, датированные определенным месяцем и датой

Таким образом, WordPress превращает практически каждый URL параметр в переменную выборки.

Чтобы понять цикл, полезно разобрать шаги, которые WordPress предпринимает, чтобы сгенерировать контент страницы:

1. URL соответствует файлам и директориям, имеющимся в WordPress. Если файл существует, он загружается веб-сервером. WordPress, по сути, не участвует в этом решении. Должен ли URL обрабатываться веб-сервером или же его следует превратить в запрос к БД, решают веб-сервер и файл *.htaccess*.
2. Если URL не загружает файл ядра WordPress, он должен быть проанализирован, чтобы решить, какой контент загружать. Веб-сервер начинает с загрузки ядра WordPress через *index.php*, чтобы задать параметры для цикла. При посещении страницы какой-либо метки, например `http://example.com/tag/acf`, WordPress определит, что вы просматриваете метку, загрузит соответствующий шаблон, выберет записи, сохраненные с этой меткой, и сгенерирует определённые данные.
3. Трансформация URL в выбранный контент происходит внутри метода `parse_query()` объекта `WP_Query`, который WordPress создал ранее в процессе выполнения. WordPress сначала разбирает URL на набор параметров запроса. Все строки запроса из URL переда­ются в WordPress для определения отображаемого контента. Если ваш сайт использует ЧПУ, значения между слэшами - это просто параметры для строк за­проса. Например обращение к `http://example.com/tag/acf` - то же самое, что и `http://example.com?tag=acf`.
4. После этого WordPress конвертирует URL параметры в запрос для базы данных, чтобы вернуть контент. Рабочей лошадкой тут явля­ется метод `get_posts()` внутри объекта `WP_Query`, который берет все параметры запроса и превращает их в операторы SQL, в конечном счете посылая строку SQL на сервер баз данных MySQL и извлекая желаемый контент. Контент, возвращенный из базы данных, сохраняется в объекте `WP_Query`, чтобы использоваться в цикле WordPress, и кэшируется для ускорения других обращений к тем же самым постам до выполнения другого запроса базы данных.
5. После возвращения контента WordPress устанавливает все условные теги `is_`, такие как `is_home()`, `is_page()` и т. д. Они устанавливаются как часть выполняемого запроса по умолчанию на основе парсинга URL, и мы еще рассмотрим случаи, когда может потребоваться сбросить эти теги.
6. WordPress выбирает необходимый шаблон в теме оформления, основываясь на типе запроса и числе воз­вращенных записей (например, единичная запись или запрос по катего­рии) и полученные по запросу данные передаются в процедуру цикла по умолчанию.

После того как заданы параметры запроса - посредством парсинга URL, заданно­го пользователем, или явного задания в специально настроенном цикле, метод `get_posts()` объекта `WP_Query` транслирует эти параметры в SQL запрос базы данных. Помимо того что вы можете во многом контролировать тип, выборку и порядок отображение контента с помощью параметров запроса, ядро WordPress также предоставляет фильтры, чтобы позволить вам изменить сгенерированный SQL для тончайшего контроля выбора контента и его группировки.

Базовый формат запроса SQL:

```sql
SELECT fields FROM table WHERE conditions
```

Условия, опреде­ленные в операторе `WHERE`, меняют порядок, группировку и число возвращаемых записей.

`table` - это не просто таблица `posts` в базе данных MySQL, которые содержат все данные постов. Это также может быть JOIN из двух или большего числа таблиц, где вам необходимо выбрать записи на основе иерархических метаданных. В WordPress любая запись может быть легко отмечена разными метками или помещена в более чем одну категорию. Например, чтобы выбрать записи с меткой `acf`, необходимо сначала найти `acf` в таблице метаданных таксономии, построить в памяти промежуточную таблицу постов, которые были отмечены в категории `acf`, затем выбрать посты, ID которых содержатся одновременно и во временной таблице и в главной таблице контента WordPress. 

Большая часть преобразования строки запроса в SQL запрос выполняется в файле *wp-includes/query.php*, а основная часть работы JOIN определяется в *wp-includes/taxonomy.php*.

По умолчанию для осуществления выборки цикл использует контекст запрошенного URL, но вы также мо­жете выполнять кастомную выборку контента используя например объект `WP_Query` (подробней об этом в разделе [Пользовательский цикл WordPress](custom_query.md)).

## Базовый цикл

Самый простой цикл WordPress может выглядить таким образом:

```php
if (have_posts()) :
  while(have_posts()): the_post(); 
    // loop content - template tags, html, etc
    the_content();
  endwhile;
  else:
    _e( 'Sorry, no posts matched your criteria.', 'textdomain' );
endif; 
```

Оператор `if` проверяет, существует ли хотя бы одна запись, поскольку у вас может не быть записей в выбранной категории и с нужной меткой. Если контент суще­ствует, оператор `while` используется для запуска цикла.

Функция `have_posts()` проверяет существует ли ещё записи в БД.

Функция `the_post()` вызывается для построения данных записи, делая их доступными для других функций WordPress. После того как будут созданны данные, вы можете отобразить контент цикла в необходимом вам виде. Эта функция должна быть вызвана внутри цикла, чтобы данные записи были установлены корректно. Вызов `the_post()` в свою очередь вызывает функцию `setup_postdata()`, 
чтобы установить метаданные записи, такие как автор и метки контента, которые вы можете отображать в цикле. Эти данные передаются глобальной переменной каждый раз во время итерации цикла. Функция `the_post()` также устанавливает глобальную переменную `$post`, которая используется тегами шаблонов.

Если вы хотите чтобы ваша тема поддерживала мультиязычность и была готова для перевода на другие языки, то вам следует позаботиться о том чтобы вместо обычных текстовых строк вам нужно оборачиваться их в функцию `_e()`, где первым параметром вы передаёте саму строку, вторым уникальный `textdomain`.

## Множественные циклы

Если вам нужно вызывать один и тот же цикл (например стандартный цикл WordPress) в нескольких местах нужно использовать функцию `rewind_posts()` для того чтобы можно было использовать его повторно.

```php
// Start the main loop
if ( have_posts() ) : 
    while ( have_posts() ) : the_post();
        the_title();
    endwhile;
endif;

// Use rewind_posts() to use the query a second time.
rewind_posts();

// Start a new loop
while ( have_posts() ) : the_post();
    the_content();
endwhile;
```

Чтобы вызывать различные циклы несколько раз на странице нужно использовать определённые функции такие как `wp_reset_postdata()` , которые нужны для сброса данных поста, иначе вы можете не совсем ожидаемый результат на который расчитываете.

```php
// The main query.
if ( have_posts() ) : 
    while ( have_posts() ) : the_post();
        the_title();
        the_content();
    endwhile;
else :
    // When no posts are found, output this text.
    _e( 'Sorry, no posts matched your criteria.' );
endif;
wp_reset_postdata();

/*
 * The secondary query. Note that you can use any category name here. In our example, we use "example-category".
 */
$secondary_query = new WP_Query( 'category_name=example-category' );

// The second loop.
if ( $secondary_query->have_posts() ) :
    echo '<ul>';
    while ( $secondary_query->have_posts() ) :
        $secondary_query->the_post();
        echo '<li>' . get_the_title() . '</li>';
    endwhile;
    echo '</ul>';
endif;
wp_reset_postdata();
```

Объект `WP_Query` используется для вывода любых данных из БД в любом месте на сайте, включая вывод кастомных типов постов и таксономий. Об этом подробнее в разделе [Пользовательский цикл WordPress](../plugin/custom_loop.md)